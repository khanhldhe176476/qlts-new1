{% extends "layouts/base.html" %}

{% block page_title %}
    {% if status == 'maintenance' %}
        Tài sản đang bảo trì
    {% else %}
        Danh sách tài sản
    {% endif %}
{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item"><a href="{{ url_for('index') }}">Tổng quan</a></li>
{% if status == 'maintenance' %}
    <li class="breadcrumb-item active">Tài sản đang bảo trì</li>
{% else %}
    <li class="breadcrumb-item active">Tài sản</li>
{% endif %}
{% endblock %}

{% block content %}
<div class="card">
    <div class="card-header">
        <h3 class="card-title">
            {% if status == 'maintenance' %}
                Tài sản đang bảo trì
            {% else %}
                Danh sách tài sản
            {% endif %}
        </h3>
        {% if session.role in ['admin', 'manager'] %}
        <div class="card-tools">
            <div class="action-buttons-group">
                <a href="{{ url_for('add_asset') }}" class="btn btn-primary btn-sm action-btn">
                    <i class="fas fa-plus"></i> Thêm tài sản
                </a>
                <a href="{{ url_for('import_assets') }}" class="btn btn-info btn-sm action-btn">
                    <i class="fas fa-file-import"></i> Import Excel
                </a>
                <div class="btn-group action-btn" role="group">
                    <button type="button" class="btn btn-success btn-sm dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" id="exportDropdownBtn">
                        <i class="fas fa-file-export"></i> Xuất dữ liệu
                    </button>
                    <div class="dropdown-menu dropdown-menu-right" aria-labelledby="exportDropdownBtn">
                        <a class="dropdown-item" href="{{ url_for('export_assets', fmt='csv') }}"><i class="fas fa-file-csv mr-2"></i>CSV</a>
                        <a class="dropdown-item" href="{{ url_for('export_assets', fmt='xlsx') }}"><i class="fas fa-file-excel mr-2 text-success"></i>Excel (.xlsx)</a>
                        <a class="dropdown-item" href="{{ url_for('export_assets', fmt='json') }}"><i class="fas fa-code mr-2"></i>JSON</a>
                        <div class="dropdown-divider"></div>
                        <a class="dropdown-item" href="{{ url_for('export_assets', fmt='docx') }}"><i class="fas fa-file-word mr-2 text-primary"></i>Word (.docx)</a>
                        <a class="dropdown-item" href="{{ url_for('export_assets', fmt='pdf') }}"><i class="fas fa-file-pdf mr-2 text-danger"></i>PDF</a>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}
    </div>
    <div class="card-body">
        <!-- Filter -->
        <div class="row mb-3">
            <div class="col-md-8">
                <form method="GET" class="form-inline" id="assetFilterForm">
                    <div class="input-group filter-input-group">
                        <input type="text" class="form-control" name="search" placeholder="Tìm theo tên tài sản..." value="{{ search or '' }}">
                        {% if status %}
                        <input type="hidden" name="status" value="{{ status }}">
                        {% endif %}
                        <select class="form-control filter-select" name="type_id" id="assetTypeFilter" onchange="document.getElementById('assetFilterForm').submit()">
                            <option value="">Tất cả loại</option>
                            {% for t in asset_types %}
                            <option value="{{ t.id }}" {% if type_id and t.id==type_id %}selected{% endif %}>{{ t.name }}</option>
                            {% endfor %}
                        </select>
                        <div class="input-group-append">
                            <button class="btn btn-outline-secondary" type="submit"><i class="fas fa-search"></i></button>
                            {% if search or type_id %}
                            <a class="btn btn-outline-danger" href="{{ url_for('assets') }}"><i class="fas fa-times"></i></a>
                            {% endif %}
                        </div>
                    </div>
                </form>
            </div>
            <div class="col-md-4 text-right">
                <small class="text-muted">Hiển thị {{ assets.items|length }} / {{ assets.total }} kết quả</small>
            </div>
        </div>

        {% if assets.items %}
        <div class="table-responsive">
            <table class="table table-bordered table-striped" id="assetsTable">
                <thead>
                    <tr>
                        <th>STT</th>
                        <th>Tên tài sản</th>
                        <th>Giá tiền (VNĐ)</th>
                        <th>Ngày mua</th>
                        <th>Số lượng</th>
                        <th>Mã thiết bị</th>
                        <th>Người sử dụng</th>
                        <th>Tình trạng</th>
                        <th>Trạng thái</th>
                        {% if session.role != 'user' %}
                        <th>Bảo hành</th>
                        <th>Hóa đơn</th>
                        {% endif %}
                        <th>Ghi chú</th>
                        {% if session.role in ['admin', 'manager'] %}
                        <th>Thao tác</th>
                        {% endif %}
                    </tr>
                </thead>
                <tbody>
                    {% for asset in assets.items %}
                    <tr>
                        <td>{{ loop.index + ((assets.page-1) * assets.per_page) }}</td>
                        <td>{{ asset.name }}</td>
                        <td>{{ asset.price|currency }}</td>
                        <td>{{ asset.purchase_date|vn_date }}</td>
                        <td>{{ asset.quantity }}</td>
                        <td>{% if asset.device_code %}{{ asset.device_code }}{% endif %}</td>
                        <td>{{ asset.user.username if asset.user else 'Không có' }}</td>
                        <td>{% if asset.condition_label %}{{ asset.condition_label }}{% else %}<span class="text-muted">Chưa có</span>{% endif %}</td>
                        <td>
                            {{ 'Đang sử dụng' if asset.status == 'active'
                               else 'Bảo trì' if asset.status == 'maintenance'
                               else 'Đã thanh lý' }}
                        </td>
                        {% if session.role != 'user' %}
                        <td>
                            {% if asset.has_warranty() %}
                                {% set warranty_status, warranty_text = asset.get_warranty_status() %}
                                {% if warranty_status == 'active' %}
                                    <span class="badge badge-success" title="{{ warranty_text }}">
                                        <i class="fas fa-shield-alt"></i> {{ asset.warranty_start_date|vn_date }} - {{ asset.warranty_end_date|vn_date }}
                                    </span>
                                {% elif warranty_status == 'expired' %}
                                    <span class="badge badge-danger" title="{{ warranty_text }}">
                                        <i class="fas fa-shield-alt"></i> Hết hạn
                                    </span>
                                {% else %}
                                    <span class="badge badge-info" title="{{ warranty_text }}">
                                        <i class="fas fa-shield-alt"></i> {{ asset.warranty_start_date|vn_date }} - {{ asset.warranty_end_date|vn_date }}
                                    </span>
                                {% endif %}
                            {% else %}
                                <span class="text-muted">Không có</span>
                            {% endif %}
                        </td>
                        <td class="invoice-cell">
                            {% if asset.invoice_file_path %}
                                {% set invoice_lower = asset.invoice_file_path|lower %}
                                {% set is_image = invoice_lower.endswith('.png') or invoice_lower.endswith('.jpg') or invoice_lower.endswith('.jpeg') or invoice_lower.endswith('.gif') or invoice_lower.endswith('.bmp') or invoice_lower.endswith('.webp') %}
                                {% if is_image %}
                                    <a href="{{ url_for('download_invoice', filename=asset.invoice_file_path) }}" target="_blank" class="invoice-thumb-link" title="Xem/Tải hóa đơn">
                                        <img src="{{ url_for('download_invoice', filename=asset.invoice_file_path, inline=1) }}" alt="Invoice image" class="invoice-thumb img-thumbnail">
                                    </a>
                                {% else %}
                                    <a href="{{ url_for('download_invoice', filename=asset.invoice_file_path) }}" target="_blank" class="btn btn-sm btn-outline-primary" title="Tải hóa đơn">
                                        <i class="fas fa-file-download"></i>
                                    </a>
                                {% endif %}
                            {% else %}
                                <span class="text-muted">Không có</span>
                            {% endif %}
                        </td>
                        {% endif %}
                        <td>{{ asset.notes or '' }}</td>
                        {% if session.role in ['admin', 'manager'] %}
                        <td class="actions">
                            {% if session.role in ['admin', 'manager'] %}
                            <a href="{{ url_for('edit_asset', id=asset.id) }}" class="btn btn-sm btn-warning">
                                <i class="fas fa-edit"></i>
                            </a>
                            <a href="{{ url_for('delete_asset', id=asset.id) }}" class="btn btn-sm btn-danger" data-confirm="Bạn có chắc chắn muốn xóa tài sản này?">
                                <i class="fas fa-trash"></i>
                            </a>
                            {% endif %}
                        </td>
                        {% endif %}
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="text-center py-4">
            <i class="fas fa-box fa-3x text-muted mb-3"></i>
            <p class="text-muted">Chưa có tài sản nào. {% if session.role in ['admin', 'manager'] %}<a href="{{ url_for('add_asset') }}">Thêm tài sản đầu tiên</a>{% else %}<span>Liên hệ quản lý để thêm tài sản</span>{% endif %}
            </p>
        </div>
        {% endif %}
        {% if assets.pages > 1 %}
        <nav aria-label="Assets pagination">
            <ul class="pagination justify-content-center">
                {% if assets.page > 1 %}
                <li class="page-item">
                    <a class="page-link" href="{{ url_for('assets', page=1, search=search, type_id=type_id, status=status) }}">«</a>
                </li>
                <li class="page-item">
                    <a class="page-link" href="{{ url_for('assets', page=assets.prev_num, search=search, type_id=type_id, status=status) }}">‹</a>
                </li>
                {% endif %}

                {% for page_num in assets.iter_pages(left_edge=1, right_edge=1, left_current=1, right_current=2) %}
                    {% if page_num %}
                        {% if page_num == assets.page %}
                        <li class="page-item active"><span class="page-link">{{ page_num }}</span></li>
                        {% else %}
                        <li class="page-item"><a class="page-link" href="{{ url_for('assets', page=page_num, search=search, type_id=type_id, status=status) }}">{{ page_num }}</a></li>
                        {% endif %}
                    {% else %}
                        <li class="page-item disabled"><span class="page-link">…</span></li>
                    {% endif %}
                {% endfor %}

                {% if assets.has_next %}
                <li class="page-item">
                    <a class="page-link" href="{{ url_for('assets', page=assets.next_num, search=search, type_id=type_id, status=status) }}">›</a>
                </li>
                <li class="page-item">
                    <a class="page-link" href="{{ url_for('assets', page=assets.pages, search=search, type_id=type_id, status=status) }}">»</a>
                </li>
                {% endif %}
            </ul>
        </nav>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
  (function(){
    var typeSelect = document.getElementById('assetTypeFilter');
    if(typeSelect){
      typeSelect.addEventListener('change', function(){
        document.getElementById('assetFilterForm').submit();
      });
    }
    
    // Đảm bảo dropdown "Xuất dữ liệu" hoạt động
    $(document).ready(function() {
      // Khởi tạo Bootstrap dropdown
      $('.dropdown-toggle').dropdown();
      
      // Đảm bảo click vào nút dropdown hoạt động
      $('#exportDropdownBtn').on('click', function(e) {
        // Cho phép Bootstrap xử lý dropdown
        // Không preventDefault để Bootstrap có thể toggle
      });
    });

    // Autocomplete cho ô tìm kiếm tài sản
    if (typeof initSearchAutocomplete === 'function') {
      initSearchAutocomplete('#assetFilterForm input[name="search"]', {
        endpoint: "{{ url_for('assets_suggest') }}",
        minChars: 2,
        renderItem: function (item) {
          var code = item.device_code ? ' <small class="text-muted">(' + item.device_code + ')</small>' : '';
          return '<strong>' + (item.name || '') + '</strong>' + code;
        },
        onSelect: function (item, input) {
          // Gán tên tài sản vào ô tìm kiếm và submit form
          input.value = item.name || item.label || '';
          if (input.form) {
            input.form.submit();
          }
        }
      });
    }
  })();
</script>
{% endblock %}