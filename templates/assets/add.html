{% extends "layouts/base.html" %}

{% block page_title %}Thêm tài sản{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item"><a href="{{ url_for('index') }}">Tổng quan</a></li>
<li class="breadcrumb-item"><a href="{{ url_for('assets') }}">Tài sản</a></li>
<li class="breadcrumb-item active">Thêm mới</li>
{% endblock %}

{% block content %}
<div class="card">
    <div class="card-header">
        <h3 class="card-title">Thêm tài sản mới</h3>
    </div>
    <form method="POST" enctype="multipart/form-data">
        <div class="card-body">
            <div class="row">
                <div class="col-md-6">
                    <div class="form-group">
                        <label for="asset_name_input">Tên tài sản <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="asset_name_input" name="name" placeholder="Nhập tên tài sản">
                        <small class="form-text text-muted">
                            Bạn cũng có thể nhập nhiều tên ở phần &quot;Danh sách tài sản thêm&quot; phía dưới để tạo hàng loạt.
                        </small>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="form-group">
                        <label for="asset_type_id">Loại tài sản <span class="text-danger">*</span></label>
                        <select class="form-control" id="asset_type_id" name="asset_type_id" required>
                            <option value="">Chọn loại tài sản</option>
                            {% for asset_type in asset_types %}
                            <option value="{{ asset_type.id }}">{{ asset_type.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
            </div>

            <!-- Thêm nhiều tài sản cùng lúc (tùy chọn) -->
            <div class="row mt-2">
                <div class="col-md-12">
                    <div class="form-group">
                        <label for="name_list">Danh sách tài sản thêm</label>
                        <textarea class="form-control" id="name_list" name="name_list" rows="3"
                                  placeholder="VD:
Laptop Dell XPS 13
Màn hình HP 24 inch
Chuột Logitech MX Master"></textarea>
                        <small class="form-text text-muted">
                            Nếu nhập danh sách ở đây, hệ thống sẽ tạo nhiều tài sản với các thông tin còn lại giống nhau.
                            Trường &quot;Tên tài sản&quot; phía trên có thể để trống.
                        </small>
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col-md-6">
                    <div class="form-group">
                        <label for="price">Giá (VNĐ) <span class="text-danger">*</span></label>
                        <input type="number" class="form-control" id="price" name="price" step="0.01" min="0" required>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="form-group">
                        <label for="quantity">Số lượng <span class="text-danger">*</span></label>
                        <input type="number" class="form-control" id="quantity" name="quantity" min="1" value="1"
                            required>
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col-md-4">
                    <div class="form-group">
                        <label for="purchase_date">Ngày mua</label>
                        <input type="date" class="form-control" id="purchase_date" name="purchase_date"
                            placeholder="dd/mm/yyyy" max="{{ today_iso }}">
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="form-group">
                        <label for="device_code">Mã thiết bị</label>
                        <input type="text" class="form-control" id="device_code" name="device_code"
                            placeholder="VD: MH10">
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="form-group">
                        <label for="condition_label">Tình trạng</label>
                        <select class="form-control" id="condition_label" name="condition_label">
                            <option value="">-- Chọn --</option>
                            <option value="Mới">Mới</option>
                            <option value="Còn tốt">Còn tốt</option>
                            <option value="Cần kiểm tra">Cần kiểm tra</option>
                        </select>
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col-md-6">
                    <div class="form-group">
                        <label for="user_id">Người sở hữu</label>
                        <select class="form-control" id="user_id" name="user_id">
                            <option value="">Chọn người sở hữu</option>
                            {% for user in users %}
                            <option value="{{ user.id }}">{{ user.username }} - {{ user.email }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="form-group">
                        <label for="status">Trạng thái <span class="text-danger">*</span></label>
                        <select class="form-control" id="status" name="status" required>
                            <option value="active">Đang sử dụng</option>
                            <option value="maintenance">Bảo trì</option>
                            <option value="disposed">Đã thanh lý</option>
                        </select>
                    </div>
                </div>
            </div>

            <div class="form-group">
                <label for="user_text">Ghi chú của người dùng</label>
                <textarea class="form-control" id="user_text" name="user_text" rows="2"></textarea>
            </div>

            <div class="form-group">
                <label for="notes">Ghi chú quản trị</label>
                <div class="form-row">
                    <div class="form-group col-md-6">
                        <label class="small mb-1">Thời gian sử dụng (tháng)</label>
                        <input type="number" min="0" class="form-control" name="usage_months" placeholder="VD: 12">
                    </div>
                    <div class="form-group col-md-6">
                        <label class="small mb-1">Độ mới (%)</label>
                        <input type="number" min="0" max="100" class="form-control" name="condition_percent"
                            placeholder="0-100">
                    </div>
                </div>
                <label class="small mb-1" for="notes">Ghi chú:</label>
                <textarea class="form-control" id="notes" name="notes" rows="2"></textarea>
            </div>

            <!-- Tùy chọn sinh chứng từ sau khi thêm -->
            <div class="card mt-3">
                <div class="card-header bg-warning">
                    <h5 class="card-title mb-0"><i class="fas fa-file-alt mr-2"></i>Chứng từ sau khi thêm</h5>
                </div>
                <div class="card-body">
                    <div class="form-group">
                        <label>Hành động</label>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="voucher_action" id="voucher_none" value="none" checked>
                            <label class="form-check-label" for="voucher_none">Chỉ tạo tài sản (không sinh chứng từ)</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="voucher_action" id="voucher_increase" value="increase">
                            <label class="form-check-label" for="voucher_increase">Sinh chứng từ ghi tăng</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="voucher_action" id="voucher_decrease" value="decrease">
                            <label class="form-check-label" for="voucher_decrease">Sinh chứng từ ghi giảm</label>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="voucher_description">Diễn giải chứng từ (tùy chọn)</label>
                        <textarea class="form-control" id="voucher_description" name="voucher_description" rows="2" placeholder="VD: Ghi tăng tài sản mới, nguồn mua sắm..."></textarea>
                    </div>
                </div>
            </div>

            <!-- Thông tin bảo hành -->
            <div class="card mt-3">
                <div class="card-header bg-info text-white">
                    <h5 class="card-title mb-0"><i class="fas fa-shield-alt mr-2"></i>Thông tin bảo hành</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="warranty_start_date">Ngày bắt đầu bảo hành</label>
                                <input type="date" class="form-control" id="warranty_start_date"
                                    name="warranty_start_date" placeholder="dd/mm/yyyy">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="warranty_period_months">Thời gian bảo hành (tháng)</label>
                                <input type="number" min="0" class="form-control" id="warranty_period_months"
                                    name="warranty_period_months" placeholder="VD: 12">
                                <small class="form-text text-muted">Ngày kết thúc sẽ được tính tự động</small>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="warranty_contact_name">Tên người liên hệ</label>
                                <input type="text" class="form-control" id="warranty_contact_name"
                                    name="warranty_contact_name" placeholder="VD: Nguyễn Văn A">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="warranty_contact_phone">Số điện thoại</label>
                                <input type="tel" class="form-control" id="warranty_contact_phone"
                                    name="warranty_contact_phone" placeholder="VD: 0901234567" inputmode="numeric"
                                    pattern="[0-9]*">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="warranty_contact_email">Email</label>
                                <input type="email" class="form-control" id="warranty_contact_email"
                                    name="warranty_contact_email" placeholder="VD: contact@example.com">
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="warranty_website">Website/Link bảo hành</label>
                        <input type="url" class="form-control" id="warranty_website" name="warranty_website"
                            placeholder="VD: https://warranty.example.com">
                    </div>
                </div>
            </div>

            <!-- Upload hóa đơn/phiếu giao hàng -->
            <div class="card mt-3">
                <div class="card-header bg-success text-white">
                    <h5 class="card-title mb-0"><i class="fas fa-file-invoice mr-2"></i>Hóa đơn/Phiếu giao hàng</h5>
                </div>
                <div class="card-body">
                    <div class="form-group">
                        <label for="invoice_file">Upload hóa đơn hoặc phiếu giao hàng</label>
                        <input type="file" class="form-control-file" id="invoice_file" name="invoice_file"
                            accept=".pdf,.png,.jpg,.jpeg,.gif,.bmp,.webp,.svg,.tif,.tiff,.ico,.avif,.doc,.docx,.xls,.xlsx">
                        <small class="form-text text-muted">Định dạng: PDF, PNG, JPG, JPEG, GIF, BMP, WebP, SVG,
                            TIF/TIFF, ICO, AVIF, Word, Excel (tối đa 10MB)</small>
                    </div>
                </div>
            </div>
        </div>
        <div class="card-footer">
            <button type="submit" class="btn btn-primary">
                <i class="fas fa-save"></i> Lưu
            </button>
            <a href="{{ url_for('assets') }}" class="btn btn-secondary">
                <i class="fas fa-arrow-left"></i> Quay lại
            </a>
        </div>
    </form>
</div>
{% endblock %}

{% block extra_js %}
<script>
  (function(){
    var typeSelect = document.getElementById('assetTypeFilter');
    if(typeSelect){
      typeSelect.addEventListener('change', function(){
        document.getElementById('assetFilterForm').submit();
      });
    }
  })();

  // Khi chọn tên tài sản có sẵn, đẩy xuống "Danh sách tài sản thêm"
  document.addEventListener('DOMContentLoaded', function() {
    var select = document.getElementById('asset_name_select');
    var textarea = document.getElementById('name_list');
    if (!select || !textarea) return;

    select.addEventListener('change', function() {
      var name = this.value;
      if (!name) return;

      var current = textarea.value || '';
      var lines = current.split(/\r?\n/).map(function(l){ return l.trim(); }).filter(function(l){ return l.length > 0; });

      if (lines.indexOf(name) === -1) {
        lines.push(name);
      }

      textarea.value = lines.join('\n') + '\n';

      this.selectedIndex = 0;
    });
  });
</script>
{% endblock %}