{% extends "layouts/base.html" %}

{% block page_title %}Danh sách bàn giao tài sản{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item"><a href="{{ url_for('index') }}">Tổng quan</a></li>
<li class="breadcrumb-item active">Bàn giao tài sản</li>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="card">
                <div class="card-header">
                <h3 class="card-title"><i class="fas fa-exchange-alt mr-2"></i>Danh sách bàn giao tài sản</h3>
                <div class="card-tools">
                    <a href="{{ url_for('transfer_create') }}" class="btn btn-primary btn-sm">
                        <i class="fas fa-plus mr-2"></i>Tạo bàn giao mới
                    </a>
                </div>
            </div>
            <div class="card-body">
                <div class="alert alert-info">
                    <i class="fas fa-info-circle mr-2"></i>
                    Email tự động đã bị vô hiệu hóa. Vui lòng sao chép nút <strong>Link xác nhận</strong> và gửi thủ công cho nhân viên nhận tài sản.
                </div>
                <!-- Filters -->
                <div class="row mb-3">
                    <div class="col-md-4">
                        <form method="GET" class="form-inline">
                            <select class="form-control" name="status" onchange="this.form.submit()">
                                <option value="">Tất cả trạng thái</option>
                                <option value="pending" {% if status == 'pending' %}selected{% endif %}>Chờ xác nhận</option>
                                <option value="confirmed" {% if status == 'confirmed' %}selected{% endif %}>Đã xác nhận</option>
                                <option value="rejected" {% if status == 'rejected' %}selected{% endif %}>Đã từ chối</option>
                                <option value="cancelled" {% if status == 'cancelled' %}selected{% endif %}>Đã hủy</option>
                            </select>
                        </form>
                    </div>
                </div>
                
                {% if transfers.items %}
                <div class="table-responsive">
                    <table class="table table-bordered table-striped">
                        <thead>
                            <tr>
                                <th>Mã bàn giao</th>
                                <th>Tài sản</th>
                                <th>Người gửi</th>
                                <th>Người nhận</th>
                                <th>Số lượng</th>
                                <th>Đã xác nhận</th>
                                <th>Trạng thái</th>
                                <th>Ngày tạo</th>
                                <th>Thao tác</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for transfer in transfers.items %}
                            <tr>
                                <td><strong>{{ transfer.transfer_code }}</strong></td>
                                <td>{{ transfer.asset.name }}</td>
                                <td>{{ transfer.from_user.username }}</td>
                                <td>{{ transfer.to_user.username }}</td>
                                <td>{{ transfer.expected_quantity }}</td>
                                <td>
                                    {{ transfer.confirmed_quantity }}/{{ transfer.expected_quantity }}
                                </td>
                                <td>
                                    {% if transfer.status == 'confirmed' %}
                                        Đã xác nhận
                                    {% elif transfer.status == 'pending' %}
                                        Chờ xác nhận
                                    {% elif transfer.status == 'rejected' %}
                                        Đã từ chối
                                    {% else %}
                                        Đã hủy
                                    {% endif %}
                                </td>
                                <td>{{ transfer.created_at|vn_date(include_time=True) }}</td>
                                <td>
                                    <div class="d-flex align-items-center" style="gap: 0.5rem;">
                                        <a href="{{ url_for('transfer_confirm', token=transfer.confirmation_token) }}" 
                                           class="btn btn-sm btn-info"
                                           title="Mở màn hình xác nhận trong hệ thống">
                                            <i class="fas fa-link"></i>
                                        </a>
                                        <button type="button" 
                                                class="btn btn-sm btn-secondary copy-link-btn" 
                                                data-copy-url="{{ url_for('transfer_confirm', token=transfer.confirmation_token, _external=True) }}"
                                                data-toggle="tooltip" 
                                                title="Sao chép link xác nhận">
                                            <i class="fas fa-copy"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                
                <!-- Pagination -->
                {% if transfers.pages > 1 %}
                <div class="mt-3">
                    <nav aria-label="Transfer pagination">
                        <ul class="pagination justify-content-center mb-0">
                            {% if transfers.page > 1 %}
                            <li class="page-item">
                                <a class="page-link" href="{{ url_for('transfer_list', page=1, status=status) }}">«</a>
                            </li>
                            <li class="page-item">
                                <a class="page-link" href="{{ url_for('transfer_list', page=transfers.prev_num, status=status) }}">‹</a>
                            </li>
                            {% endif %}
                            
                            {% for page_num in transfers.iter_pages(left_edge=1, right_edge=1, left_current=1, right_current=2) %}
                                {% if page_num %}
                                    {% if page_num == transfers.page %}
                                    <li class="page-item active">
                                        <span class="page-link">{{ page_num }}</span>
                                    </li>
                                    {% else %}
                                    <li class="page-item">
                                        <a class="page-link" href="{{ url_for('transfer_list', page=page_num, status=status) }}">{{ page_num }}</a>
                                    </li>
                                    {% endif %}
                                {% else %}
                                    <li class="page-item disabled"><span class="page-link">…</span></li>
                                {% endif %}
                            {% endfor %}
                            
                            {% if transfers.has_next %}
                            <li class="page-item">
                                <a class="page-link" href="{{ url_for('transfer_list', page=transfers.next_num, status=status) }}">›</a>
                            </li>
                            <li class="page-item">
                                <a class="page-link" href="{{ url_for('transfer_list', page=transfers.pages, status=status) }}">»</a>
                            </li>
                            {% endif %}
                        </ul>
                    </nav>
                </div>
                {% endif %}
                {% else %}
                <div class="text-center py-4">
                    <i class="fas fa-exchange-alt fa-3x text-muted mb-3"></i>
                    <p class="text-muted">Chưa có bàn giao nào. <a href="{{ url_for('transfer_create') }}">Tạo bàn giao đầu tiên</a></p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    // Khởi tạo tooltip
    $('[data-toggle="tooltip"]').tooltip();
    
    // Xử lý sao chép link
    $('.copy-link-btn').on('click', function(e) {
        e.preventDefault();
        const url = $(this).data('copy-url');
        const button = $(this);
        const originalTitle = button.attr('title');
        
        // Sao chép vào clipboard
        if (navigator.clipboard && navigator.clipboard.writeText) {
            navigator.clipboard.writeText(url).then(function() {
                // Thành công - cập nhật tooltip
                button.attr('title', 'Đã sao chép!').tooltip('_fixTitle').tooltip('show');
                
                // Đổi icon tạm thời
                const icon = button.find('i');
                icon.removeClass('fa-copy').addClass('fa-check');
                button.removeClass('btn-secondary').addClass('btn-success');
                
                // Khôi phục sau 2 giây
                setTimeout(function() {
                    button.attr('title', originalTitle).tooltip('_fixTitle');
                    icon.removeClass('fa-check').addClass('fa-copy');
                    button.removeClass('btn-success').addClass('btn-secondary');
                }, 2000);
            }).catch(function(err) {
                console.error('Lỗi khi sao chép:', err);
                // Fallback: sử dụng phương pháp cũ
                fallbackCopyTextToClipboard(url, button, originalTitle);
            });
        } else {
            // Fallback cho trình duyệt cũ
            fallbackCopyTextToClipboard(url, button, originalTitle);
        }
    });
    
    // Phương pháp fallback để sao chép
    function fallbackCopyTextToClipboard(text, button, originalTitle) {
        const textArea = document.createElement("textarea");
        textArea.value = text;
        textArea.style.top = "0";
        textArea.style.left = "0";
        textArea.style.position = "fixed";
        document.body.appendChild(textArea);
        textArea.focus();
        textArea.select();
        
        try {
            const successful = document.execCommand('copy');
            if (successful) {
                button.attr('title', 'Đã sao chép!').tooltip('_fixTitle').tooltip('show');
                const icon = button.find('i');
                icon.removeClass('fa-copy').addClass('fa-check');
                button.removeClass('btn-secondary').addClass('btn-success');
                
                setTimeout(function() {
                    button.attr('title', originalTitle).tooltip('_fixTitle');
                    icon.removeClass('fa-check').addClass('fa-copy');
                    button.removeClass('btn-success').addClass('btn-secondary');
                }, 2000);
            } else {
                alert('Không thể sao chép. Vui lòng sao chép thủ công: ' + text);
            }
        } catch (err) {
            console.error('Lỗi khi sao chép:', err);
            alert('Không thể sao chép. Vui lòng sao chép thủ công: ' + text);
        }
        
        document.body.removeChild(textArea);
    }
});
</script>
{% endblock %}

