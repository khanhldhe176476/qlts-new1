{% extends "layouts/base.html" %}

{% block page_title %}Danh mục báo cáo{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item"><a href="{{ url_for('index') }}">Tổng quan</a></li>
<li class="breadcrumb-item active">Danh mục báo cáo</li>
{% endblock %}

{% block content %}
<!-- Filter Section -->
<div class="card mb-3">
    <div class="card-body">
        <form id="filterForm" class="form-row align-items-end">
            <div class="form-group col-md-3">
                <label for="filterYear">Năm</label>
                <input type="number" id="filterYear" name="year" min="2000" max="2100" 
                       value="{{ year }}" class="form-control" required>
            </div>
            <div class="form-group col-md-4">
                <label for="filterAssetType">Loại tài sản</label>
                <select id="filterAssetType" name="asset_type_id" class="form-control">
                    <option value="">Tất cả</option>
                    {% for t in asset_types %}
                    <option value="{{ t.id }}" {% if asset_type_id == t.id %}selected{% endif %}>{{ t.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="form-group col-md-4">
                <label for="filterUnit">Đơn vị phụ trách</label>
                <select id="filterUnit" name="unit_id" class="form-control">
                    <option value="">Tất cả</option>
                    {% for u in units %}
                    <option value="{{ u.id }}" {% if unit_id == u.id %}selected{% endif %}>{{ u.username }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="form-group col-md-1">
                <button type="submit" class="btn btn-warning btn-block" style="background-color: #f97316; border-color: #f97316; color: white;">
                    <i class="fas fa-filter"></i> Lọc
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Charts Row 1 -->
<div class="row">
    <!-- (A) Cơ cấu theo loại -->
    <div class="col-lg-4 mb-3">
        <div class="card h-100">
            <div class="card-header">
                <h3 class="card-title"><i class="fas fa-chart-pie mr-2"></i>Cơ cấu theo loại</h3>
            </div>
            <div class="card-body position-relative">
                <div class="chart-loading" id="loading1" style="display: none;">
                    <div class="text-center py-5">
                        <i class="fas fa-spinner fa-spin fa-2x text-muted"></i>
                        <p class="text-muted mt-2">Đang tải dữ liệu...</p>
                    </div>
                </div>
                <div class="chart-error" id="error1" style="display: none;">
                    <div class="text-center py-5 text-danger">
                        <i class="fas fa-exclamation-triangle fa-2x"></i>
                        <p class="mt-2">Không thể tải dữ liệu</p>
                    </div>
                </div>
                <div class="chart-no-data" id="noData1" style="display: none;">
                    <div class="text-center py-5 text-muted">
                        <i class="fas fa-inbox fa-2x"></i>
                        <p class="mt-2">Không có dữ liệu</p>
                    </div>
                </div>
                <canvas id="chartAssetStructure" height="200"></canvas>
            </div>
        </div>
    </div>

    <!-- (B) Tình trạng sử dụng -->
    <div class="col-lg-4 mb-3">
        <div class="card h-100">
            <div class="card-header">
                <h3 class="card-title"><i class="fas fa-signal mr-2"></i>Tình trạng sử dụng</h3>
            </div>
            <div class="card-body position-relative">
                <div class="chart-loading" id="loading2" style="display: none;">
                    <div class="text-center py-5">
                        <i class="fas fa-spinner fa-spin fa-2x text-muted"></i>
                        <p class="text-muted mt-2">Đang tải dữ liệu...</p>
                    </div>
                </div>
                <div class="chart-error" id="error2" style="display: none;">
                    <div class="text-center py-5 text-danger">
                        <i class="fas fa-exclamation-triangle fa-2x"></i>
                        <p class="mt-2">Không thể tải dữ liệu</p>
                    </div>
                </div>
                <div class="chart-no-data" id="noData2" style="display: none;">
                    <div class="text-center py-5 text-muted">
                        <i class="fas fa-inbox fa-2x"></i>
                        <p class="mt-2">Không có dữ liệu</p>
                    </div>
                </div>
                <canvas id="chartUsageStatus" height="200"></canvas>
            </div>
        </div>
    </div>

    <!-- (C) Lý do biến động -->
    <div class="col-lg-4 mb-3">
        <div class="card h-100">
            <div class="card-header">
                <h3 class="card-title"><i class="fas fa-random mr-2"></i>Lý do biến động</h3>
            </div>
            <div class="card-body position-relative">
                <div class="chart-loading" id="loading3" style="display: none;">
                    <div class="text-center py-5">
                        <i class="fas fa-spinner fa-spin fa-2x text-muted"></i>
                        <p class="text-muted mt-2">Đang tải dữ liệu...</p>
                    </div>
                </div>
                <div class="chart-error" id="error3" style="display: none;">
                    <div class="text-center py-5 text-danger">
                        <i class="fas fa-exclamation-triangle fa-2x"></i>
                        <p class="mt-2">Không thể tải dữ liệu</p>
                    </div>
                </div>
                <div class="chart-no-data" id="noData3" style="display: none;">
                    <div class="text-center py-5 text-muted">
                        <i class="fas fa-inbox fa-2x"></i>
                        <p class="mt-2">Không có dữ liệu</p>
                    </div>
                </div>
                <canvas id="chartChangeReason" height="200"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Charts Row 2 -->
<div class="row">
    <!-- (D) Tăng/Giảm theo tháng -->
    <div class="col-lg-6 mb-3">
        <div class="card h-100">
            <div class="card-header">
                <h3 class="card-title"><i class="fas fa-chart-area mr-2"></i>Tăng/Giảm theo tháng</h3>
            </div>
            <div class="card-body position-relative">
                <div class="chart-loading" id="loading4" style="display: none;">
                    <div class="text-center py-5">
                        <i class="fas fa-spinner fa-spin fa-2x text-muted"></i>
                        <p class="text-muted mt-2">Đang tải dữ liệu...</p>
                    </div>
                </div>
                <div class="chart-error" id="error4" style="display: none;">
                    <div class="text-center py-5 text-danger">
                        <i class="fas fa-exclamation-triangle fa-2x"></i>
                        <p class="mt-2">Không thể tải dữ liệu</p>
                    </div>
                </div>
                <div class="chart-no-data" id="noData4" style="display: none;">
                    <div class="text-center py-5 text-muted">
                        <i class="fas fa-inbox fa-2x"></i>
                        <p class="mt-2">Không có dữ liệu</p>
                    </div>
                </div>
                <canvas id="chartChangeByMonth" height="220"></canvas>
            </div>
        </div>
    </div>

    <!-- (E) Hao mòn theo tháng -->
    <div class="col-lg-6 mb-3">
        <div class="card h-100">
            <div class="card-header">
                <h3 class="card-title"><i class="fas fa-chart-line mr-2"></i>Hao mòn theo tháng</h3>
            </div>
            <div class="card-body position-relative">
                <div class="chart-loading" id="loading5" style="display: none;">
                    <div class="text-center py-5">
                        <i class="fas fa-spinner fa-spin fa-2x text-muted"></i>
                        <p class="text-muted mt-2">Đang tải dữ liệu...</p>
                    </div>
                </div>
                <div class="chart-error" id="error5" style="display: none;">
                    <div class="text-center py-5 text-danger">
                        <i class="fas fa-exclamation-triangle fa-2x"></i>
                        <p class="mt-2">Không thể tải dữ liệu</p>
                    </div>
                </div>
                <div class="chart-no-data" id="noData5" style="display: none;">
                    <div class="text-center py-5 text-muted">
                        <i class="fas fa-inbox fa-2x"></i>
                        <p class="mt-2">Không có dữ liệu</p>
                    </div>
                </div>
                <canvas id="chartDepreciation" height="220"></canvas>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
// Chart instances storage
let chartInstances = {};

// Color palette
const chartColors = {
    primary: '#2563eb',
    success: '#22c55e',
    warning: '#f97316',
    danger: '#ef4444',
    info: '#0ea5e9',
    purple: '#8b5cf6',
    pink: '#ec4899',
    yellow: '#facc15',
    teal: '#14b8a6',
    orange: '#f59e0b'
};

const palette = [
    chartColors.primary, chartColors.success, chartColors.warning, 
    chartColors.danger, chartColors.info, chartColors.purple,
    chartColors.pink, chartColors.yellow, chartColors.teal, chartColors.orange
];

// API Service
const reportService = {
    async fetchAssetStructure(filters) {
        const params = new URLSearchParams(filters);
        const response = await fetch(`/api/reports/asset-structure?${params}`);
        return await response.json();
    },
    
    async fetchUsageStatus(filters) {
        const params = new URLSearchParams(filters);
        const response = await fetch(`/api/reports/usage-status?${params}`);
        return await response.json();
    },
    
    async fetchChangeReason(filters) {
        const params = new URLSearchParams(filters);
        const response = await fetch(`/api/reports/change-reason?${params}`);
        return await response.json();
    },
    
    async fetchChangeByMonth(filters) {
        const params = new URLSearchParams(filters);
        const response = await fetch(`/api/reports/change-by-month?${params}`);
        return await response.json();
    },
    
    async fetchDepreciationByMonth(filters) {
        const params = new URLSearchParams(filters);
        const response = await fetch(`/api/reports/depreciation-by-month?${params}`);
        return await response.json();
    }
};

// Chart Helper Functions
function showLoading(chartId) {
    document.getElementById(`loading${chartId}`).style.display = 'block';
    document.getElementById(`error${chartId}`).style.display = 'none';
    document.getElementById(`noData${chartId}`).style.display = 'none';
    const canvas = document.getElementById(chartId);
    if (canvas) canvas.style.display = 'none';
}

function showError(chartId) {
    document.getElementById(`loading${chartId}`).style.display = 'none';
    document.getElementById(`error${chartId}`).style.display = 'block';
    document.getElementById(`noData${chartId}`).style.display = 'none';
    const canvas = document.getElementById(chartId);
    if (canvas) canvas.style.display = 'none';
}

function showNoData(chartId) {
    document.getElementById(`loading${chartId}`).style.display = 'none';
    document.getElementById(`error${chartId}`).style.display = 'none';
    document.getElementById(`noData${chartId}`).style.display = 'block';
    const canvas = document.getElementById(chartId);
    if (canvas) canvas.style.display = 'none';
}

function showChart(chartId) {
    document.getElementById(`loading${chartId}`).style.display = 'none';
    document.getElementById(`error${chartId}`).style.display = 'none';
    document.getElementById(`noData${chartId}`).style.display = 'none';
    const canvas = document.getElementById(chartId);
    if (canvas) canvas.style.display = 'block';
}

function destroyChart(chartId) {
    if (chartInstances[chartId]) {
        chartInstances[chartId].destroy();
        delete chartInstances[chartId];
    }
}

// (A) Cơ cấu theo loại - Pie Chart
async function loadAssetStructureChart(filters) {
    const chartId = 'chartAssetStructure';
    showLoading('1');
    
    try {
        const result = await reportService.fetchAssetStructure(filters);
        
        if (!result.success || !result.data || result.data.length === 0) {
            showNoData('1');
            return;
        }
        
        showChart(chartId);
        destroyChart(chartId);
        
        const ctx = document.getElementById(chartId);
        chartInstances[chartId] = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: result.data.map(d => d.label),
                datasets: [{
                    data: result.data.map(d => d.value),
                    backgroundColor: palette.slice(0, result.data.length)
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: {
                        position: 'bottom'
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                const percentage = ((context.parsed / total) * 100).toFixed(1);
                                return `${context.label}: ${context.parsed} (${percentage}%)`;
                            }
                        }
                    }
                }
            }
        });
    } catch (error) {
        console.error('Error loading asset structure chart:', error);
        showError('1');
    }
}

// (B) Tình trạng sử dụng - Bar Chart
async function loadUsageStatusChart(filters) {
    const chartId = 'chartUsageStatus';
    showLoading('2');
    
    try {
        const result = await reportService.fetchUsageStatus(filters);
        
        if (!result.success || !result.data || result.data.length === 0) {
            showNoData('2');
            return;
        }
        
        showChart(chartId);
        destroyChart(chartId);
        
        const ctx = document.getElementById(chartId);
        chartInstances[chartId] = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: result.data.map(d => d.label),
                datasets: [{
                    label: 'Số lượng',
                    data: result.data.map(d => d.value),
                    backgroundColor: [
                        chartColors.success,
                        chartColors.warning,
                        chartColors.danger,
                        chartColors.info
                    ].slice(0, result.data.length)
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            stepSize: 1
                        }
                    }
                }
            }
        });
    } catch (error) {
        console.error('Error loading usage status chart:', error);
        showError('2');
    }
}

// (C) Lý do biến động - Pie Chart
async function loadChangeReasonChart(filters) {
    const chartId = 'chartChangeReason';
    showLoading('3');
    
    try {
        const result = await reportService.fetchChangeReason(filters);
        
        if (!result.success || !result.data || result.data.length === 0) {
            showNoData('3');
            return;
        }
        
        showChart(chartId);
        destroyChart(chartId);
        
        const ctx = document.getElementById(chartId);
        chartInstances[chartId] = new Chart(ctx, {
            type: 'pie',
            data: {
                labels: result.data.map(d => d.label),
                datasets: [{
                    data: result.data.map(d => d.value),
                    backgroundColor: [
                        chartColors.success,
                        chartColors.danger,
                        chartColors.info
                    ].slice(0, result.data.length)
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: {
                        position: 'bottom'
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                const percentage = total > 0 ? ((context.parsed / total) * 100).toFixed(1) : 0;
                                return `${context.label}: ${context.parsed} (${percentage}%)`;
                            }
                        }
                    }
                }
            }
        });
    } catch (error) {
        console.error('Error loading change reason chart:', error);
        showError('3');
    }
}

// (D) Tăng/Giảm theo tháng - Line Chart
async function loadChangeByMonthChart(filters) {
    const chartId = 'chartChangeByMonth';
    showLoading('4');
    
    try {
        const result = await reportService.fetchChangeByMonth(filters);
        
        if (!result.success || !result.data || result.data.labels.length === 0) {
            showNoData('4');
            return;
        }
        
        showChart(chartId);
        destroyChart(chartId);
        
        const ctx = document.getElementById(chartId);
        chartInstances[chartId] = new Chart(ctx, {
            type: 'line',
            data: {
                labels: result.data.labels,
                datasets: [
                    {
                        label: 'Tăng',
                        data: result.data.increase,
                        borderColor: chartColors.success,
                        backgroundColor: chartColors.success + '20',
                        fill: true,
                        tension: 0.4
                    },
                    {
                        label: 'Giảm',
                        data: result.data.decrease,
                        borderColor: chartColors.danger,
                        backgroundColor: chartColors.danger + '20',
                        fill: true,
                        tension: 0.4
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: {
                        position: 'bottom'
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            stepSize: 1
                        }
                    }
                }
            }
        });
    } catch (error) {
        console.error('Error loading change by month chart:', error);
        showError('4');
    }
}

// (E) Hao mòn theo tháng - Line Chart
async function loadDepreciationChart(filters) {
    const chartId = 'chartDepreciation';
    showLoading('5');
    
    try {
        const result = await reportService.fetchDepreciationByMonth(filters);
        
        if (!result.success || !result.data || result.data.labels.length === 0) {
            showNoData('5');
            return;
        }
        
        showChart(chartId);
        destroyChart(chartId);
        
        const ctx = document.getElementById(chartId);
        chartInstances[chartId] = new Chart(ctx, {
            type: 'line',
            data: {
                labels: result.data.labels,
                datasets: [{
                    label: 'Hao mòn',
                    data: result.data.depreciation,
                    borderColor: chartColors.warning,
                    backgroundColor: chartColors.warning + '20',
                    fill: true,
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return `Hao mòn: ${context.parsed.y.toLocaleString('vi-VN')}`;
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return value.toLocaleString('vi-VN');
                                }
                            }
                    }
                }
            }
        });
    } catch (error) {
        console.error('Error loading depreciation chart:', error);
        showError('5');
    }
}

// Load all charts
async function loadAllCharts() {
    const filters = {
        year: document.getElementById('filterYear').value,
        asset_type_id: document.getElementById('filterAssetType').value || '',
        unit_id: document.getElementById('filterUnit').value || ''
    };
    
    // Remove empty filters
    Object.keys(filters).forEach(key => {
        if (filters[key] === '') delete filters[key];
    });
    
    // Load all charts in parallel
    await Promise.all([
        loadAssetStructureChart(filters),
        loadUsageStatusChart(filters),
        loadChangeReasonChart(filters),
        loadChangeByMonthChart(filters),
        loadDepreciationChart(filters)
    ]);
}

// Debounce function
function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}

// Debounced load function
const debouncedLoadCharts = debounce(loadAllCharts, 500);

// Form submit handler
document.getElementById('filterForm').addEventListener('submit', function(e) {
    e.preventDefault();
    loadAllCharts();
});

// Auto-load on page load
document.addEventListener('DOMContentLoaded', function() {
    loadAllCharts();
});
</script>
{% endblock %}
