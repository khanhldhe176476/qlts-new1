{% extends "layouts/base.html" %}

{% block page_title %}Báo cáo & Thống kê{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item"><a href="{{ url_for('index') }}">Tổng quan</a></li>
<li class="breadcrumb-item active">Dashboard báo cáo</li>
{% endblock %}

{% block content %}
<div class="card mb-3">
    <div class="card-body">
        <form class="form-row align-items-end" method="get">
            <div class="form-group col-md-4">
                <label>Loại tài sản</label>
                <select name="asset_type_id" class="form-control">
                    <option value="">Tất cả</option>
                    {% for t in asset_types %}
                    <option value="{{ t.id }}" {% if asset_type_id == t.id %}selected{% endif %}>{{ t.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="form-group col-md-4">
                <label>Đơn vị phụ trách</label>
                <select name="unit_id" class="form-control">
                    <option value="">Tất cả</option>
                    {% for u in units %}
                    <option value="{{ u.id }}" {% if unit_id == u.id %}selected{% endif %}>{{ u.username }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="form-group col-md-1">
                <button type="submit" class="btn btn-primary btn-block"><i class="fas fa-filter"></i></button>
            </div>
        </form>
    </div>
</div>

<div class="row mb-4">
    <div class="col-md-3 col-sm-6 mb-3">
        <div class="small-box bg-primary">
            <div class="inner">
                <h3>{{ summary.total_assets }}</h3>
                <p>Tổng số tài sản</p>
            </div>
            <div class="icon"><i class="fas fa-boxes"></i></div>
        </div>
    </div>
    <div class="col-md-3 col-sm-6 mb-3">
        <div class="small-box bg-success">
            <div class="inner">
                <h3>{{ '{:,.0f}'.format(summary.total_value).replace(',', '.') }}</h3>
                <p>Tổng giá trị</p>
            </div>
            <div class="icon"><i class="fas fa-donate"></i></div>
        </div>
    </div>
    <div class="col-md-3 col-sm-6 mb-3">
        <div class="small-box bg-danger">
            <div class="inner">
                <h3>{{ summary.disposed_assets }}</h3>
                <p>Tài sản đã ghi giảm</p>
            </div>
            <div class="icon"><i class="fas fa-times-circle"></i></div>
        </div>
    </div>
    <div class="col-md-3 col-sm-6 mb-3">
        <div class="small-box bg-info">
            <div class="inner">
                <h3>{{ summary.transfer_count }}</h3>
                <p>Số lượt điều chuyển</p>
            </div>
            <div class="icon"><i class="fas fa-random"></i></div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-lg-7 mb-3">
        <div class="card h-100">
            <div class="card-header">
                <h3 class="card-title"><i class="fas fa-layer-group mr-2"></i>Biểu đồ Tăng/Giảm/Hao mòn</h3>
            </div>
            <div class="card-body">
                <canvas id="stackedChart" height="200"></canvas>
            </div>
        </div>
    </div>
    <div class="col-lg-5 mb-3">
        <div class="card h-100">
            <div class="card-header">
                <h3 class="card-title"><i class="fas fa-chart-line mr-2"></i>Xu hướng giá trị ròng</h3>
            </div>
            <div class="card-body">
                <canvas id="trendChart" height="200"></canvas>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
const stackedPayload = {{ stacked_payload|safe }};
const trendPayload = {{ trend_payload|safe }};

const ctxStacked = document.getElementById('stackedChart');
if (ctxStacked && stackedPayload.labels.length) {
    new Chart(ctxStacked, {
        type: 'bar',
        data: stackedPayload,
        options: {
            responsive: true,
            plugins: { legend: { position: 'bottom' } },
            scales: {
                x: { stacked: true },
                y: { stacked: true, ticks: { callback: value => value.toLocaleString() } }
            }
        }
    });
}

const ctxTrend = document.getElementById('trendChart');
if (ctxTrend && trendPayload.labels.length) {
    new Chart(ctxTrend, {
        type: 'line',
        data: trendPayload,
        options: {
            responsive: true,
            plugins: { legend: { display: false } },
            scales: {
                y: { ticks: { callback: value => value.toLocaleString() } }
            }
        }
    });
}
</script>
{% endblock %}

