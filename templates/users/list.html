{% extends "layouts/base.html" %}

{% block page_title %}Danh sách người dùng{% endblock %}

{% block breadcrumb %}{% endblock %}

{% block extra_js %}
<script>
    (function () {
        // Autocomplete cho ô tìm kiếm người dùng
        if (typeof initSearchAutocomplete === 'function') {
            initSearchAutocomplete('#userFilterForm input[name="search"]', {
                endpoint: "{{ url_for('users_suggest') }}",
                minChars: 2,
                renderItem: function (item) {
                    var username = item.username || '';
                    var email = item.email || '';
                    if (email) {
                        return '<strong>' + username + '</strong> <small class="text-muted">(' + email + ')</small>';
                    }
                    return '<strong>' + (item.label || username) + '</strong>';
                },
                onSelect: function (item, input) {
                    var value = item.username || item.email || item.label || '';
                    input.value = value;
                    if (input.form) {
                        input.form.submit();
                    }
                }
            });
        }
    })();
</script>
{% endblock %}

{% block content %}
<!-- Tool Header & Actions -->
<div class="d-flex justify-content-between align-items-center mb-4">
    <h3 class="font-weight-bold mb-0 text-dark">
        <i class="fas fa-users mr-2 text-success"></i>Quản lý người dùng
    </h3>
    <div>
        <a href="{{ url_for('add_user') }}" class="btn btn-luxury btn-luxury-primary shadow-sm">
            <i class="fas fa-user-plus mr-2"></i> Thêm người dùng
        </a>
    </div>
</div>

<!-- Filters Luxury Card -->
<div class="luxury-card mb-4 border-0">
    <div class="luxury-card-body p-3">
        <form method="GET" id="userFilterForm">
            <div class="row align-items-center">
                <div class="col-lg-7">
                    <div class="input-group luxury-search">
                        <div class="input-group-prepend">
                            <span class="input-group-text bg-white border-right-0"
                                style="border-radius: 10px 0 0 10px;"><i class="fas fa-search text-muted"></i></span>
                        </div>
                        <input type="text" class="form-control border-right-0 border-left-0" name="search"
                            placeholder="Tìm kiếm người dùng hoặc email..." value="{{ search or '' }}"
                            style="height: 46px;">
                        <select class="form-control filter-select border-left-0" name="role_id" id="roleFilter"
                            style="height: 46px; border-radius: 0 10px 10px 0; max-width: 200px; cursor: pointer;"
                            onchange="this.form.submit()">
                            <option value="">Tất cả vai trò</option>
                            {% for r in roles %}
                            <option value="{{ r.id }}" {% if role_id and r.id==role_id %}selected{% endif %}>{{
                                r.name|title }}</option>
                            {% endfor %}
                        </select>

                        {% if search or role_id %}
                        <div class="input-group-append ml-2">
                            <a href="{{ url_for('users') }}" class="btn btn-light d-flex align-items-center px-3"
                                style="border: 1px solid #e2e8f0; border-radius: 10px;">
                                <i class="fas fa-times mr-2 text-muted"></i>Xóa lọc
                            </a>
                        </div>
                        {% endif %}
                    </div>
                </div>
                <div class="col-lg-5 text-right mt-3 mt-lg-0">
                    <span class="text-muted small font-weight-bold">
                        Hiển thị {{ users.items|length }} / {{ users.total }} kết quả
                    </span>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- Table Card -->
<div class="luxury-card border-0 shadow-sm overflow-hidden">
    <div class="table-responsive">
        <table class="luxury-table">
            <thead>
                <tr>
                    <th width="70" class="text-center">STT</th>
                    <th>Người dùng</th>
                    <th>Email & Tài khoản</th>
                    <th>Vai trò</th>
                    <th class="text-center">Trạng thái</th>
                    <th class="text-center">Tài sản</th>
                    <th>Ngày tạo</th>
                    <th class="text-right">Thao tác</th>
                </tr>
            </thead>
            <tbody>
                {% for user in users.items %}
                <tr>
                    <td class="text-center">
                        <span class="text-muted font-weight-bold">{{ loop.index + ((users.page-1) * users.per_page)
                            }}</span>
                    </td>
                    <td>
                        <div class="d-flex align-items-center">
                            <div class="avatar-circle mr-2 bg-light text-primary d-flex align-items-center justify-content-center"
                                style="width: 32px; height: 32px; border-radius: 50%; border: 1px solid #e2e8f0;">
                                <i class="fas fa-user small"></i>
                            </div>
                            <span class="font-weight-bold text-dark">{{ user.name if user.name else
                                (user.email.split('@')[0] if user.email else user.username) }}</span>
                        </div>
                    </td>
                    <td>
                        <div class="text-dark">{{ user.username }}</div>
                        <small class="text-muted">{{ user.email }}</small>
                    </td>
                    <td>
                        {% set r = user.role.name if user.role else '' %}
                        {% set role_label = {
                        'super_admin': 'Hệ thống',
                        'admin': 'Quản trị viên',
                        'manager': 'Quản lý',
                        'accountant': 'Kế toán',
                        'inventory_leader': 'Tổ trưởng',
                        'inventory_member': 'Thành viên',
                        'user': 'Người dùng'
                        }[r] if r in
                        ['super_admin','admin','manager','accountant','inventory_leader','inventory_member','user'] else
                        (r|title) %}
                        {% set badge = {
                        'super_admin': 'bg-dark text-white',
                        'admin': 'badge-danger',
                        'manager': 'badge-warning',
                        'accountant': 'badge-primary',
                        'inventory_leader': 'badge-info',
                        'inventory_member': 'bg-secondary text-white',
                        'user': 'badge-success'
                        }.get(r, 'badge-info') %}
                        <span class="luxury-badge {{ badge }}">{{ role_label }}</span>
                    </td>
                    <td class="text-center">
                        <span class="luxury-badge {{ 'badge-success' if user.is_active else 'badge-danger' }}">
                            {{ 'Hoạt động' if user.is_active else 'Khóa' }}
                        </span>
                    </td>
                    <td class="text-center">
                        <span class="luxury-badge bg-light text-info border font-weight-bold px-3">
                            {{ user.assigned_asset_count }}
                        </span>
                    </td>
                    <td><span class="text-muted small">{{ user.created_at|vn_date(True) }}</span></td>
                    <td class="text-right">
                        <div class="d-flex justify-content-end">
                            <a href="{{ url_for('view_user', id=user.id) }}" class="btn-action btn-action-view"
                                title="Xem chi tiết">
                                <i class="fas fa-eye"></i>
                            </a>
                            <a href="{{ url_for('edit_user', id=user.id) }}" class="btn-action btn-action-edit"
                                title="Sửa">
                                <i class="fas fa-edit"></i>
                            </a>
                            <a href="{{ url_for('delete_user', id=user.id) }}" class="btn-action btn-action-delete"
                                onclick="return confirm('Bạn có chắc chắn muốn xóa người dùng \'{{ user.username }}\'?')"
                                title="Xóa">
                                <i class="fas fa-trash"></i>
                            </a>
                        </div>
                    </td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="8" class="text-center py-5">
                        <div class="py-5">
                            <i class="fas fa-users-slash fa-4x text-muted mb-4 opacity-25"></i>
                            <h4 class="font-weight-bold text-muted">Không tìm thấy người dùng</h4>
                            <p class="text-muted">Dữ liệu không tồn tại hoặc bộ lọc không khớp</p>
                            <a href="{{ url_for('users') }}" class="btn btn-luxury btn-luxury-white mt-2">Xem tất cả</a>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Pagination -->
    {% if users.pages > 1 %}
    <div class="luxury-card-footer bg-white border-top p-4">
        <nav aria-label="User pagination">
            <ul class="pagination pagination-luxury justify-content-center mb-0">
                {% if users.page > 1 %}
                <li class="page-item">
                    <a class="page-link"
                        href="{{ url_for('users', page=users.prev_num, search=search, role_id=role_id) }}">
                        <i class="fas fa-chevron-left"></i>
                    </a>
                </li>
                {% endif %}

                {% for page_num in users.iter_pages(left_edge=1, right_edge=1, left_current=1, right_current=2) %}
                {% if page_num %}
                <li class="page-item {% if page_num == users.page %}active{% endif %}">
                    <a class="page-link" href="{{ url_for('users', page=page_num, search=search, role_id=role_id) }}">{{
                        page_num }}</a>
                </li>
                {% else %}
                <li class="page-item disabled"><span class="page-link">…</span></li>
                {% endif %}
                {% endfor %}

                {% if users.has_next %}
                <li class="page-item">
                    <a class="page-link"
                        href="{{ url_for('users', page=users.next_num, search=search, role_id=role_id) }}">
                        <i class="fas fa-chevron-right"></i>
                    </a>
                </li>
                {% endif %}
            </ul>
        </nav>
    </div>
    {% endif %}
</div>
{% endblock %}