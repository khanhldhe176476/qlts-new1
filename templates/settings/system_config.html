{% extends "layouts/base.html" %}

{% block page_title %}Cấu hình hệ thống{% endblock %}

{% block breadcrumb %}
<ol class="breadcrumb float-sm-right">
    <li class="breadcrumb-item"><a href="{{ url_for('index') }}">Tổng quan</a></li>
    <li class="breadcrumb-item"><a href="{{ url_for('settings') }}">Cài đặt</a></li>
    <li class="breadcrumb-item active">Cấu hình hệ thống</li>
</ol>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">
                    <i class="fas fa-cog mr-2"></i>
                    Cấu hình hệ thống
                </h3>
                <div class="card-tools">
                    <a href="{{ url_for('settings') }}" class="btn btn-sm btn-secondary">
                        <i class="fas fa-times"></i> Hủy bỏ
                    </a>
                </div>
            </div>
            <div class="card-body">
                <p class="text-muted mb-4">Quản lý thương hiệu, logo và các thiết lập chung của ứng dụng.</p>
                
                <form method="POST" action="{{ url_for('system_config') }}" enctype="multipart/form-data" id="systemConfigForm">
                    <!-- Thiết lập thương hiệu -->
                    <div class="card card-outline card-primary mb-4">
                        <div class="card-header">
                            <h3 class="card-title">
                                <i class="fas fa-window-restore mr-2"></i>
                                Thiết lập thương hiệu
                            </h3>
                        </div>
                        <div class="card-body">
                            <p class="text-muted">Thông tin hiển thị trên thanh tiêu đề và trình duyệt.</p>
                            
                            <div class="form-group">
                                <label for="org_name">
                                    <i class="fas fa-building mr-1"></i>
                                    Tên đơn vị / Tổ chức
                                </label>
                                <input type="text" class="form-control" id="org_name" name="org_name" 
                                       value="{{ org_name }}" placeholder="Nhập tên đơn vị">
                                <small class="form-text text-muted">Hiển thị bên cạnh Logo trên thanh Header.</small>
                            </div>
                            
                            <div class="form-group">
                                <label for="browser_title">
                                    <i class="fas fa-globe mr-1"></i>
                                    Tiêu đề trình duyệt
                                </label>
                                <input type="text" class="form-control" id="browser_title" name="browser_title" 
                                       value="{{ browser_title }}" placeholder="Nhập tiêu đề trình duyệt">
                                <small class="form-text text-muted">Tiêu đề hiển thị trên tab của trình duyệt.</small>
                            </div>
                            
                            <div class="form-group">
                                <label for="logo">
                                    <i class="fas fa-image mr-1"></i>
                                    Logo hệ thống
                                </label>
                                <div class="border rounded p-3 text-center" style="border-style: dashed !important; min-height: 150px; display: flex; align-items: center; justify-content: center; background-color: #f8f9fa;">
                                    <div id="logoPreview" style="display: none;">
                                        <img id="logoPreviewImg" src="" alt="Logo preview" style="max-width: 200px; max-height: 150px; width: auto; height: auto; object-fit: contain; margin-bottom: 10px;">
                                        <br>
                                        <button type="button" class="btn btn-sm btn-danger" onclick="clearLogo()">
                                            <i class="fas fa-times"></i> Xóa
                                        </button>
                                    </div>
                                    <div id="logoUploadArea">
                                        {% if logo_path and logo_path != url_for('static', filename='img/logo.png') %}
                                        <img src="{{ logo_path }}" alt="Logo hiện tại" style="max-width: 200px; max-height: 150px; width: auto; height: auto; object-fit: contain; margin-bottom: 10px;">
                                        <br>
                                        {% endif %}
                                        <input type="file" class="d-none" id="logo" name="logo" accept="image/png,image/jpeg,image/jpg,image/svg+xml,image/gif" onchange="previewLogo(this)">
                                        <label for="logo" class="btn btn-outline-primary" style="cursor: pointer;">
                                            <i class="fas fa-upload mr-2"></i>
                                            Kéo thả hoặc click để tải lên
                                        </label>
                                        <p class="text-muted mt-2 mb-0" style="font-size: 0.875rem;">PNG, JPG, SVG tối đa 2MB</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save mr-2"></i> Lưu cấu hình
                        </button>
                        <a href="{{ url_for('settings') }}" class="btn btn-secondary">
                            <i class="fas fa-times mr-2"></i> Hủy
                        </a>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">
                    <i class="fas fa-desktop mr-2"></i>
                    Live Header Preview
                </h3>
            </div>
            <div class="card-body">
                <!-- Browser Tab Preview -->
                <div class="mb-3">
                    <div class="d-flex align-items-center mb-2" style="background: #f0f0f0; padding: 8px 12px; border-radius: 4px 4px 0 0;">
                        <img id="previewTabIcon" src="{{ logo_path }}" alt="Icon" style="width: 16px; height: 16px; max-width: 16px; max-height: 16px; object-fit: contain; margin-right: 8px;">
                        <span id="previewTabTitle" style="font-size: 0.875rem; color: #333; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; max-width: 200px;">
                            {{ browser_title[:30] }}{% if browser_title|length > 30 %}...{% endif %}
                        </span>
                        <span style="margin-left: auto; color: #999;">×</span>
                    </div>
                    <div class="d-flex" style="gap: 4px;">
                        <div style="width: 20px; height: 20px; background: #ddd; border-radius: 2px;"></div>
                        <div style="width: 20px; height: 20px; background: #ffa500; border-radius: 2px;"></div>
                    </div>
                </div>
                
                <!-- Header Preview -->
                <div class="border rounded p-3" style="background: #fff;">
                    <div class="d-flex align-items-center mb-2">
                        <img id="previewHeaderLogo" src="{{ logo_path }}" alt="Logo" style="width: 40px; height: 40px; max-width: 40px; max-height: 40px; object-fit: contain; margin-right: 12px;">
                        <div>
                            <div id="previewOrgName" style="font-size: 1.1rem; font-weight: bold; color: #6f42c1;">
                                {{ org_name or 'Tên đơn vị' }}
                            </div>
                            <div style="font-size: 0.875rem; color: #999;">SYSTEM</div>
                        </div>
                    </div>
                </div>
                
                <!-- Content Placeholder -->
                <div class="mt-3 p-3 border rounded" style="background: #f8f9fa; min-height: 200px;">
                    <div class="text-muted text-center">
                        <i class="fas fa-th-large" style="font-size: 2rem; opacity: 0.3;"></i>
                        <p class="mt-2 mb-0">Nội dung ứng dụng</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function previewLogo(input) {
    if (input.files && input.files[0]) {
        const reader = new FileReader();
        reader.onload = function(e) {
            document.getElementById('logoPreviewImg').src = e.target.result;
            document.getElementById('logoPreview').style.display = 'block';
            document.getElementById('logoUploadArea').style.display = 'none';
            
            // Update preview
            document.getElementById('previewTabIcon').src = e.target.result;
            document.getElementById('previewHeaderLogo').src = e.target.result;
        };
        reader.readAsDataURL(input.files[0]);
    }
}

function clearLogo() {
    document.getElementById('logo').value = '';
    document.getElementById('logoPreview').style.display = 'none';
    document.getElementById('logoUploadArea').style.display = 'block';
    
    // Reset preview to original
    const originalLogo = '{{ url_for("static", filename="img/logo.png") }}';
    document.getElementById('previewTabIcon').src = originalLogo;
    document.getElementById('previewHeaderLogo').src = originalLogo;
}

// Update preview on input change
document.getElementById('org_name').addEventListener('input', function() {
    document.getElementById('previewOrgName').textContent = this.value || 'Tên đơn vị';
});

document.getElementById('browser_title').addEventListener('input', function() {
    const title = this.value || 'Tiêu đề trình duyệt';
    document.getElementById('previewTabTitle').textContent = title.length > 30 ? title.substring(0, 30) + '...' : title;
});

// Drag and drop for logo
const logoUploadArea = document.getElementById('logoUploadArea');
const logoInput = document.getElementById('logo');

logoUploadArea.addEventListener('dragover', function(e) {
    e.preventDefault();
    this.style.backgroundColor = '#e9ecef';
});

logoUploadArea.addEventListener('dragleave', function(e) {
    e.preventDefault();
    this.style.backgroundColor = '#f8f9fa';
});

logoUploadArea.addEventListener('drop', function(e) {
    e.preventDefault();
    this.style.backgroundColor = '#f8f9fa';
    
    if (e.dataTransfer.files.length > 0) {
        logoInput.files = e.dataTransfer.files;
        previewLogo(logoInput);
    }
});
</script>
{% endblock %}

