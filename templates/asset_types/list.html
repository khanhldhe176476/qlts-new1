{% extends "layouts/base.html" %}

{% block page_title %}Danh sách loại tài sản{% endblock %}

{% block breadcrumb %}{% endblock %}

{% block content %}
<!-- Tool Header & Actions -->
<div class="d-flex justify-content-between align-items-center mb-4">
    <h3 class="font-weight-bold mb-0 text-dark">
        <i class="fas fa-tags mr-2 text-info"></i>Danh sách loại tài sản
    </h3>
    <div>
        <button type="button" class="btn btn-luxury btn-luxury-primary shadow-sm" data-toggle="modal"
            data-target="#assetTypeModal" onclick="openAddModal()">
            <i class="fas fa-plus-circle"></i> Thêm loại tài sản
        </button>
    </div>
</div>

<!-- Filters Luxury Card -->
<div class="luxury-card mb-4 border-0">
    <div class="luxury-card-body p-3">
        <form method="GET" id="assetTypeFilterForm">
            <div class="row align-items-center">
                <div class="col-md-6">
                    <div class="input-group luxury-search">
                        <div class="input-group-prepend">
                            <span class="input-group-text bg-white border-right-0"
                                style="border-radius: 10px 0 0 10px;"><i class="fas fa-search text-muted"></i></span>
                        </div>
                        <input type="text" class="form-control border-left-0" name="search"
                            placeholder="Tìm kiếm loại tài sản..." value="{{ search or '' }}"
                            style="border-radius: 0 10px 10px 0; height: 46px;">
                        {% if search %}
                        <div class="input-group-append">
                            <a href="{{ url_for('asset_types') }}" class="btn btn-light d-flex align-items-center px-3"
                                style="border: 1px solid #e2e8f0; border-left: none; border-radius: 0 10px 10px 0;">
                                <i class="fas fa-times text-muted"></i>
                            </a>
                        </div>
                        {% endif %}
                    </div>
                </div>
                <div class="col-md-6 text-right">
                    <span class="text-muted small font-weight-bold">
                        Hiển thị {{ asset_types.items|length }} / {{ asset_types.total }} kết quả
                    </span>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- Table Card -->
<div class="luxury-card border-0 shadow-sm overflow-hidden">
    <div class="table-responsive">
        <table class="luxury-table" id="assetTypesTable">
            <thead>
                <tr>
                    <th width="80" class="text-center">STT</th>
                    <th>Tên loại tài sản</th>
                    <th>Mô tả chi tiết</th>
                    <th class="text-center">Số tài sản</th>
                    <th>Ngày tạo</th>
                    <th class="text-right">Thao tác</th>
                </tr>
            </thead>
            <tbody>
                {% for asset_type in asset_types.items %}
                <tr>
                    <td class="text-center">
                        <span class="text-muted font-weight-bold">{{ loop.index + ((asset_types.page-1) *
                            asset_types.per_page) }}</span>
                    </td>
                    <td>
                        <div class="font-weight-bold text-dark">{{ asset_type.name }}</div>
                    </td>
                    <td>
                        <span class="text-muted small">{{ asset_type.description[:100] }}{% if
                            asset_type.description|length > 100 %}...{% endif %}</span>
                    </td>
                    <td class="text-center">
                        <span class="luxury-badge bg-light text-primary font-weight-bold border px-3">
                            {{ asset_type.assets|length }}
                        </span>
                    </td>
                    <td>
                        <span class="text-muted small font-weight-medium">
                            <i class="far fa-calendar-alt mr-1"></i>{{ asset_type.created_at.strftime('%d/%m/%Y %H:%M')
                            }}
                        </span>
                    </td>
                    <td class="text-right">
                        <div class="d-flex justify-content-end">
                            <button type="button" class="btn-action btn-action-edit" title="Sửa"
                                onclick="openEditModal({{ asset_type.id|tojson }}, {{ asset_type.name|tojson }}, {{ asset_type.description|tojson }})">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn-action btn-action-delete btn-delete-asset-type"
                                data-id="{{ asset_type.id }}" data-name="{{ asset_type.name }}" title="Xóa">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="6" class="text-center py-5">
                        <div class="py-5">
                            <i class="fas fa-tags fa-4x text-muted mb-4 opacity-25"></i>
                            <h4 class="font-weight-bold text-muted">Không tìm thấy loại tài sản nào</h4>
                            <p class="text-muted">Dữ liệu bạn tìm kiếm không tồn tại hoặc chưa được khởi tạo</p>
                            {% if search %}
                            <a href="{{ url_for('asset_types') }}" class="btn btn-luxury btn-luxury-white mt-2">Xem tất
                                cả</a>
                            {% endif %}
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Pagination -->
    {% if asset_types.pages > 1 %}
    <div class="luxury-card-footer bg-white border-top p-4">
        <nav aria-label="Page navigation">
            <ul class="pagination pagination-luxury justify-content-center mb-0">
                {% if asset_types.has_prev %}
                <li class="page-item">
                    <a class="page-link" href="{{ url_for('asset_types', page=asset_types.prev_num, search=search) }}">
                        <i class="fas fa-chevron-left"></i>
                    </a>
                </li>
                {% endif %}

                {% for page_num in asset_types.iter_pages(left_edge=2, right_edge=2, left_current=2, right_current=3) %}
                {% if page_num %}
                <li class="page-item {% if page_num == asset_types.page %}active{% endif %}">
                    <a class="page-link" href="{{ url_for('asset_types', page=page_num, search=search) }}">{{ page_num
                        }}</a>
                </li>
                {% else %}
                <li class="page-item disabled"><span class="page-link">...</span></li>
                {% endif %}
                {% endfor %}

                {% if asset_types.has_next %}
                <li class="page-item">
                    <a class="page-link" href="{{ url_for('asset_types', page=asset_types.next_num, search=search) }}">
                        <i class="fas fa-chevron-right"></i>
                    </a>
                </li>
                {% endif %}
            </ul>
        </nav>
    </div>
    {% endif %}
</div>

<!-- Luxury Styled Modal -->
<style>
    .modal-content {
        border-radius: 20px;
        border: none;
        box-shadow: var(--shadow-lg);
    }

    .modal-header {
        border-bottom: 1px solid #f1f5f9;
        padding: 1.5rem 2rem;
    }

    .modal-title {
        font-weight: 800;
        color: var(--dark);
    }

    .modal-body {
        padding: 2rem;
    }

    .modal-footer {
        border-top: 1px solid #f1f5f9;
        padding: 1.5rem 2rem;
    }

    .form-group label {
        font-weight: 700;
        color: var(--secondary);
        font-size: 0.85rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        margin-bottom: 0.75rem;
    }

    .luxury-input {
        border-radius: 12px;
        padding: 0.75rem 1rem;
        border: 1px solid var(--border);
        transition: all 0.2s;
    }

    .luxury-input:focus {
        border-color: var(--primary);
        box-shadow: 0 0 0 4px var(--primary-light);
        outline: none;
    }
</style>

<div class="modal fade" id="assetTypeModal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header d-flex align-items-center">
                <h5 class="modal-title" id="modalTitle">Thêm loại tài sản</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Đóng">
                    <i class="fas fa-times" style="font-size: 1.25rem;"></i>
                </button>
            </div>
            <form id="assetTypeForm" onsubmit="return false;">
                <div class="modal-body">
                    <div class="form-group mb-4">
                        <label for="assetTypeName">Tên loại tài sản <span class="text-danger">*</span></label>
                        <input type="text" class="form-control luxury-input" id="assetTypeName" name="name"
                            placeholder="Ví dụ: Thiết bị văn phòng" required>
                    </div>
                    <div class="form-group">
                        <label for="assetTypeDescription">Mô tả đặc điểm</label>
                        <textarea class="form-control luxury-input" id="assetTypeDescription" name="description"
                            rows="4" placeholder="Nhập mô tả chi tiết về loại tài sản này..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-luxury btn-luxury-white" data-dismiss="modal">Hủy bỏ</button>
                    <button type="button" class="btn btn-luxury btn-luxury-primary" id="submitBtn"
                        onclick="submitForm()">
                        <i class="fas fa-save mr-2"></i> Lưu thông tin
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let currentEditId = null;

    function openAddModal() {
        currentEditId = null;
        $('#assetTypeModal').modal('show');
        $('#modalTitle').text('Thêm loại tài sản mới');
        $('#submitBtn').html('<i class="fas fa-save mr-2"></i> Lưu dữ liệu');
        document.getElementById('assetTypeForm').reset();
    }

    function openEditModal(id, name, description) {
        currentEditId = id;
        $('#modalTitle').text('Cập nhật loại tài sản');
        $('#submitBtn').html('<i class="fas fa-save mr-2"></i> Cập nhật');
        document.getElementById('assetTypeName').value = name;
        document.getElementById('assetTypeDescription').value = description;
        $('#assetTypeModal').modal('show');
    }

    function submitForm() {
        const name = document.getElementById('assetTypeName').value;
        const description = document.getElementById('assetTypeDescription').value;
        const url = currentEditId ? `/asset-types/edit/${currentEditId}` : '/asset-types/add';
        const submitBtn = document.getElementById('submitBtn');

        if (!name.trim()) {
            alert('Vui lòng nhập tên loại tài sản!');
            return;
        }

        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Đang lưu...';

        fetch(url, {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: `name=${encodeURIComponent(name)}&description=${encodeURIComponent(description)}`
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    $('#assetTypeModal').modal('hide');
                    location.reload();
                } else {
                    alert(data.message);
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = '<i class="fas fa-save mr-2"></i> Lưu thông tin';
                }
            })
            .catch(error => {
                console.log('Error:', error);
                alert('Có lỗi xảy ra!');
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<i class="fas fa-save mr-2"></i> Lưu thông tin';
            });
    }

    $(document).ready(function () {
        $(document).on('click', '.btn-delete-asset-type', async function () {
            const id = $(this).data('id');
            const name = $(this).data('name');
            const btn = $(this);

            if (await confirm(`Bạn có chắc chắn muốn xóa loại tài sản "${name}"?\nLoại tài sản sẽ được chuyển vào thùng rác.`)) {
                btn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i>');

                fetch(`/asset-types/delete/${id}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            location.reload();
                        } else {
                            alert(data.message);
                            btn.prop('disabled', false).html('<i class="fas fa-trash"></i>');
                        }
                    })
                    .catch(error => {
                        console.error('Delete error:', error);
                        alert('Đã xảy ra lỗi!');
                        btn.prop('disabled', false).html('<i class="fas fa-trash"></i>');
                    });
            }
        });
    });
</script>
{% endblock %}