{% extends "layouts/base.html" %}

{% block page_title %}Th√πng r√°c h·ªá th·ªëng{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
  <h3 class="font-weight-bold mb-0 text-dark">
    <i class="fas fa-trash-restore mr-2 text-danger"></i>Qu·∫£n l√Ω th√πng r√°c
  </h3>
  <div class="text-md-right mt-3 mt-md-0">
    <form method="GET" action="{{ url_for('trash') }}" id="moduleFilterForm" class="d-inline-block">
      <div class="input-group luxury-card border shadow-sm p-1 bg-white" style="border-radius: 12px;">
        <div class="input-group-prepend">
          <span class="input-group-text bg-transparent border-0"><i class="fas fa-filter text-muted small"></i></span>
        </div>
        <select name="module" class="form-control border-0 font-weight-bold text-dark"
          style="height: 38px; cursor: pointer;" onchange="this.form.submit()">
          <option value="all" {% if module=='all' %}selected{% endif %}>T·∫•t c·∫£ danh m·ª•c</option>
          <option value="assets" {% if module=='assets' %}selected{% endif %}>üì¶ T√†i s·∫£n ({{ assets_paginate.total }})
          </option>
          <option value="asset_type" {% if module=='asset_type' or module=='asset_types' %}selected{% endif %}>üè∑Ô∏è Lo·∫°i
            t√†i s·∫£n ({{ asset_types_paginate.total }})</option>
          <option value="users" {% if module=='users' %}selected{% endif %}>üë• Ng∆∞·ªùi d√πng ({{ users_paginate.total }})
          </option>
          <option value="maintenance" {% if module=='maintenance' %}selected{% endif %}>üõ†Ô∏è B·∫£n ghi b·∫£o tr√¨ ({{
            maintenance_paginate.total }})</option>
        </select>
      </div>
    </form>
  </div>
</div>

<!-- Assets Section -->
{% if (module == 'all' or module == 'assets') and assets_paginate.items %}
<div class="luxury-card mb-4 border-0">
  <div class="luxury-card-header bg-white border-0 d-flex justify-content-between align-items-center">
    <h5 class="luxury-card-title mb-0"><i class="fas fa-box mr-2 text-primary"></i>T√†i s·∫£n ƒë√£ x√≥a ({{
      assets_paginate.total }})</h5>
    <div class="bulk-actions" id="bulk-actions-assets" style="display: none;">
      <div class="btn-group shadow-sm">
        <button type="button" class="btn btn-luxury btn-luxury-primary" onclick="bulkRestore('asset')">
          <i class="fas fa-undo"></i> Kh√¥i ph·ª•c
        </button>
        <button type="button" class="btn btn-luxury btn-luxury-white text-danger" onclick="bulkDelete('asset')">
          <i class="fas fa-trash"></i> X√≥a vƒ©nh vi·ªÖn
        </button>
      </div>
    </div>
  </div>
  <div class="p-0">
    <div class="table-responsive">
      <table class="luxury-table">
        <thead>
          <tr>
            <th style="width: 45px;"><input type="checkbox" id="select-all-assets"
                onchange="toggleAll('assets', this.checked)"></th>
            <th>Th√¥ng tin t√†i s·∫£n</th>
            <th>Gi√° tr·ªã</th>
            <th>Ng√†y x√≥a</th>
            <th class="text-right">Thao t√°c</th>
          </tr>
        </thead>
        <tbody>
          {% for asset in assets_paginate.items %}
          <tr>
            <td><input type="checkbox" class="item-checkbox" data-module="asset" data-id="{{ asset.id }}"
                onchange="handleCheckboxChange('asset', this)"></td>
            <td>
              <div class="d-flex align-items-center">
                <div class="bg-light p-2 mr-3" style="border-radius: 8px;"><i
                    class="fas fa-laptop-code text-secondary"></i></div>
                <div>
                  <span class="d-block font-weight-bold text-dark">{{ asset.name }}</span>
                  <small class="text-muted">{{ asset.asset_type.name if asset.asset_type else 'N/A' }} | {{
                    asset.device_code or 'NO-CODE' }}</small>
                </div>
              </div>
            </td>
            <td><span class="font-weight-medium">{{ asset.price|currency }}</span></td>
            <td><span class="text-muted small">{{ asset.deleted_at|vn_date(include_time=True) }}</span></td>
            <td class="text-right">
              <div class="d-flex justify-content-end">
                <form method="POST" action="{{ url_for('trash_restore', module='asset', id=asset.id) }}" class="m-0">
                  <button type="submit" class="btn-action btn-action-restore" title="Kh√¥i ph·ª•c"
                    onclick="return confirm('Kh√¥i ph·ª•c t√†i s·∫£n n√†y?')">
                    <i class="fas fa-undo"></i>
                  </button>
                </form>
                <form method="POST" action="{{ url_for('trash_permanent_delete', module='asset', id=asset.id) }}"
                  class="m-0 ml-1">
                  <button type="submit" class="btn-action btn-action-delete" title="X√≥a vƒ©nh vi·ªÖn"
                    onclick="return confirm('X√°c nh·∫≠n X√ìA Vƒ®NH VI·ªÑN?')">
                    <i class="fas fa-trash"></i>
                  </button>
                </form>
              </div>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
  {% if assets_paginate.pages > 1 %}
  <div class="luxury-card-footer bg-white border-top p-3">
    {% include 'trash/_pagination.html' with context %}
  </div>
  {% endif %}
</div>
{% endif %}

<!-- Asset Types Section -->
{% if (module == 'all' or module == 'asset_type' or module == 'asset_types') and asset_types_paginate.items %}
<div class="luxury-card mb-4 border-0">
  <div class="luxury-card-header bg-white border-0 d-flex justify-content-between align-items-center">
    <h5 class="luxury-card-title mb-0"><i class="fas fa-tags mr-2 text-info"></i>Lo·∫°i t√†i s·∫£n ƒë√£ x√≥a ({{
      asset_types_paginate.total }})</h5>
    <div class="bulk-actions" id="bulk-actions-asset_types" style="display: none;">
      <div class="btn-group shadow-sm">
        <button type="button" class="btn btn-luxury btn-luxury-primary" onclick="bulkRestore('asset_type')">
          <i class="fas fa-undo"></i> Kh√¥i ph·ª•c
        </button>
        <button type="button" class="btn btn-luxury btn-luxury-white text-danger" onclick="bulkDelete('asset_type')">
          <i class="fas fa-trash"></i> X√≥a vƒ©nh vi·ªÖn
        </button>
      </div>
    </div>
  </div>
  <div class="p-0">
    <div class="table-responsive">
      <table class="luxury-table">
        <thead>
          <tr>
            <th style="width: 45px;"><input type="checkbox" id="select-all-asset_types"
                onchange="toggleAll('asset_types', this.checked)"></th>
            <th>T√™n lo·∫°i t√†i s·∫£n</th>
            <th>Ng√†y x√≥a</th>
            <th class="text-right">Thao t√°c</th>
          </tr>
        </thead>
        <tbody>
          {% for at in asset_types_paginate.items %}
          <tr>
            <td><input type="checkbox" class="item-checkbox" data-module="asset_type" data-id="{{ at.id }}"
                onchange="handleCheckboxChange('asset_type', this)"></td>
            <td><span class="font-weight-bold text-dark">{{ at.name }}</span></td>
            <td><span class="text-muted small">{{ at.deleted_at|vn_date(include_time=True) }}</span></td>
            <td class="text-right">
              <div class="d-flex justify-content-end">
                <form method="POST" action="{{ url_for('trash_restore', module='asset_type', id=at.id) }}" class="m-0">
                  <button type="submit" class="btn-action btn-action-restore" title="Kh√¥i ph·ª•c">
                    <i class="fas fa-undo"></i>
                  </button>
                </form>
                <form method="POST" action="{{ url_for('trash_permanent_delete', module='asset_type', id=at.id) }}"
                  class="m-0 ml-1">
                  <button type="submit" class="btn-action btn-action-delete" title="X√≥a vƒ©nh vi·ªÖn">
                    <i class="fas fa-trash"></i>
                  </button>
                </form>
              </div>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>
{% endif %}

<!-- Users Section -->
{% if (module == 'all' or module == 'users') and users_paginate.items %}
<div class="luxury-card mb-4 border-0">
  <div class="luxury-card-header bg-white border-0 d-flex justify-content-between align-items-center">
    <h5 class="luxury-card-title mb-0"><i class="fas fa-users mr-2 text-success"></i>Ng∆∞·ªùi d√πng ƒë√£ x√≥a ({{
      users_paginate.total }})</h5>
    <div class="bulk-actions" id="bulk-actions-users" style="display: none;">
      <div class="btn-group shadow-sm">
        <button type="button" class="btn btn-luxury btn-luxury-primary" onclick="bulkRestore('user')">
          <i class="fas fa-undo"></i> Kh√¥i ph·ª•c
        </button>
        <button type="button" class="btn btn-luxury btn-luxury-white text-danger" onclick="bulkDelete('user')">
          <i class="fas fa-trash"></i> X√≥a vƒ©nh vi·ªÖn
        </button>
      </div>
    </div>
  </div>
  <div class="p-0">
    <div class="table-responsive">
      <table class="luxury-table">
        <thead>
          <tr>
            <th style="width: 45px;"><input type="checkbox" id="select-all-users"
                onchange="toggleAll('users', this.checked)"></th>
            <th>Th√¥ng tin ng∆∞·ªùi d√πng</th>
            <th>Vai tr√≤</th>
            <th>Ng√†y x√≥a</th>
            <th class="text-right">Thao t√°c</th>
          </tr>
        </thead>
        <tbody>
          {% for u in users_paginate.items %}
          <tr>
            <td><input type="checkbox" class="item-checkbox" data-module="user" data-id="{{ u.id }}"
                onchange="handleCheckboxChange('user', this)"></td>
            <td>
              <span class="d-block font-weight-bold text-dark">{{ u.username }}</span>
              <small class="text-muted">{{ u.email }}</small>
            </td>
            <td><span class="luxury-badge bg-light text-dark">{{ u.role.name if u.role else 'CS' }}</span></td>
            <td><span class="text-muted small">{{ u.deleted_at|vn_date(include_time=True) }}</span></td>
            <td class="text-right">
              <div class="d-flex justify-content-end">
                <form method="POST" action="{{ url_for('trash_restore', module='user', id=u.id) }}" class="m-0">
                  <button type="submit" class="btn-action btn-action-restore" title="Kh√¥i ph·ª•c">
                    <i class="fas fa-undo"></i>
                  </button>
                </form>
                <form method="POST" action="{{ url_for('trash_permanent_delete', module='user', id=u.id) }}"
                  class="m-0 ml-1">
                  <button type="submit" class="btn-action btn-action-delete" title="X√≥a vƒ©nh vi·ªÖn">
                    <i class="fas fa-trash"></i>
                  </button>
                </form>
              </div>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>
{% endif %}

<!-- Maintenance Section -->
{% if (module == 'all' or module == 'maintenance') and maintenance_paginate.items %}
<div class="luxury-card mb-4 border-0">
  <div class="luxury-card-header bg-white border-0 d-flex justify-content-between align-items-center">
    <h5 class="luxury-card-title mb-0"><i class="fas fa-tools mr-2 text-warning"></i>B·∫£n ghi b·∫£o tr√¨ ƒë√£ x√≥a ({{
      maintenance_paginate.total }})</h5>
    <div class="bulk-actions" id="bulk-actions-maintenance" style="display: none;">
      <div class="btn-group shadow-sm">
        <button type="button" class="btn btn-luxury btn-luxury-primary" onclick="bulkRestore('maintenance')">
          <i class="fas fa-undo"></i> Kh√¥i ph·ª•c
        </button>
        <button type="button" class="btn btn-luxury btn-luxury-white text-danger" onclick="bulkDelete('maintenance')">
          <i class="fas fa-trash"></i> X√≥a vƒ©nh vi·ªÖn
        </button>
      </div>
    </div>
  </div>
  <div class="p-0">
    <div class="table-responsive">
      <table class="luxury-table">
        <thead>
          <tr>
            <th style="width: 45px;"><input type="checkbox" id="select-all-maintenance"
                onchange="toggleAll('maintenance', this.checked)"></th>
            <th>T√™n t√†i s·∫£n</th>
            <th>ƒê∆°n v·ªã b·∫£o tr√¨</th>
            <th>Chi ph√≠ (VNƒê)</th>
            <th class="text-right">Thao t√°c</th>
          </tr>
        </thead>
        <tbody>
          {% for m in maintenance_paginate.items %}
          <tr>
            <td><input type="checkbox" class="item-checkbox" data-module="maintenance" data-id="{{ m.id }}"
                onchange="handleCheckboxChange('maintenance', this)"></td>
            <td><span class="font-weight-bold text-dark">{{ m.asset.name if m.asset else 'N/A' }}</span></td>
            <td>{{ m.vendor or '-' }}</td>
            <td>{{ m.cost|currency if m.cost else '0' }}</td>
            <td class="text-right">
              <div class="d-flex justify-content-end">
                <form method="POST" action="{{ url_for('trash_restore', module='maintenance', id=m.id) }}" class="m-0">
                  <button type="submit" class="btn-action btn-action-restore" title="Kh√¥i ph·ª•c">
                    <i class="fas fa-undo"></i>
                  </button>
                </form>
                <form method="POST" action="{{ url_for('trash_permanent_delete', module='maintenance', id=m.id) }}"
                  class="m-0 ml-1">
                  <button type="submit" class="btn-action btn-action-delete" title="X√≥a vƒ©nh vi·ªÖn">
                    <i class="fas fa-trash"></i>
                  </button>
                </form>
              </div>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>
{% endif %}

{% if assets_paginate.total == 0 and asset_types_paginate.total == 0 and users_paginate.total == 0 and
maintenance_paginate.total == 0 %}
<div class="luxury-card border-0 py-5 text-center">
  <div class="py-5">
    <i class="fas fa-trash-alt fa-4x text-muted mb-4 opacity-25"></i>
    <h4 class="font-weight-bold text-muted">Th√πng r√°c ƒëang tr·ªëng</h4>
    <p class="text-muted">C√°c b·∫£n ghi b·ªã x√≥a t·∫°m th·ªùi s·∫Ω xu·∫•t hi·ªán t·∫°i ƒë√¢y</p>
  </div>
</div>
{% endif %}

<script>
  // Logic Javascript cho ch·ªçn nhi·ªÅu (Bulk actions)
  function restoreCheckboxState(module) {
    const storageKey = `trash_selected_${module}`;
    const selectedIds = JSON.parse(sessionStorage.getItem(storageKey) || '[]');
    selectedIds.forEach(id => {
      const checkbox = document.querySelector(`.item-checkbox[data-module="${module}"][data-id="${id}"]`);
      if (checkbox) checkbox.checked = true;
    });
    updateBulkActions(module);
  }

  function clearCheckboxState(module) {
    sessionStorage.removeItem(`trash_selected_${module}`);
  }

  function toggleAll(moduleId, checked) {
    const moduleMap = { 'assets': 'asset', 'asset_types': 'asset_type', 'users': 'user', 'maintenance': 'maintenance' };
    const module = moduleMap[moduleId] || moduleId;
    const checkboxes = document.querySelectorAll(`.item-checkbox[data-module="${module}"]`);
    const storageKey = `trash_selected_${module}`;
    const existingIds = JSON.parse(sessionStorage.getItem(storageKey) || '[]');
    const currentPageIds = Array.from(checkboxes).map(cb => cb.getAttribute('data-id'));

    checkboxes.forEach(cb => cb.checked = checked);

    if (checked) {
      const allIds = [...new Set([...existingIds, ...currentPageIds])];
      sessionStorage.setItem(storageKey, JSON.stringify(allIds));
    } else {
      const remainingIds = existingIds.filter(id => !currentPageIds.includes(id));
      sessionStorage.setItem(storageKey, JSON.stringify(remainingIds));
    }
    updateBulkActions(module);
  }

  function getBulkActionsId(module) {
    const mapping = { 'asset': 'assets', 'asset_type': 'asset_types', 'user': 'users', 'maintenance': 'maintenance' };
    return mapping[module] || module;
  }

  function updateBulkActions(module) {
    const storageKey = `trash_selected_${module}`;
    const allSelectedIds = JSON.parse(sessionStorage.getItem(storageKey) || '[]');
    const bulkActionsId = getBulkActionsId(module);
    const bulkActions = document.getElementById(`bulk-actions-${bulkActionsId}`);
    if (bulkActions) {
      bulkActions.style.display = allSelectedIds.length > 0 ? 'inline-flex' : 'none';
    }
  }

  function handleCheckboxChange(module, checkbox) {
    const id = checkbox.getAttribute('data-id');
    const storageKey = `trash_selected_${module}`;
    const selectedIds = JSON.parse(sessionStorage.getItem(storageKey) || '[]');
    if (checkbox.checked) {
      if (!selectedIds.includes(id)) { selectedIds.push(id); sessionStorage.setItem(storageKey, JSON.stringify(selectedIds)); }
    } else {
      const index = selectedIds.indexOf(id); if (index > -1) { selectedIds.splice(index, 1); sessionStorage.setItem(storageKey, JSON.stringify(selectedIds)); }
    }
    updateBulkActions(module);
  }

  function bulkRestore(module) {
    const ids = JSON.parse(sessionStorage.getItem(`trash_selected_${module}`) || '[]');
    if (ids.length === 0) return;
    if (!confirm(`Kh√¥i ph·ª•c ${ids.length} m·ª•c ƒë√£ ch·ªçn?`)) return;
    submitBulkForm('{{ url_for("trash_bulk_restore") }}', module, ids);
  }

  function bulkDelete(module) {
    const ids = JSON.parse(sessionStorage.getItem(`trash_selected_${module}`) || '[]');
    if (ids.length === 0) return;
    if (!confirm(`X√ìA Vƒ®NH VI·ªÑN ${ids.length} m·ª•c ƒë√£ ch·ªçn?`)) return;
    submitBulkForm('{{ url_for("trash_bulk_delete") }}', module, ids);
  }

  function submitBulkForm(action, module, ids) {
    const form = document.createElement('form');
    form.method = 'POST'; form.action = action;
    const modInput = document.createElement('input');
    modInput.type = 'hidden'; modInput.name = 'module'; modInput.value = module;
    form.appendChild(modInput);
    ids.forEach(id => {
      const input = document.createElement('input'); input.type = 'hidden'; input.name = 'ids'; input.value = id;
      form.appendChild(input);
    });
    document.body.appendChild(form);
    clearCheckboxState(module);
    form.submit();
  }

  document.addEventListener('DOMContentLoaded', function () {
    ['asset', 'asset_type', 'user', 'maintenance'].forEach(m => restoreCheckboxState(m));
  });
</script>
{% endblock %}